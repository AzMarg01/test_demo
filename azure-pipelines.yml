trigger: none
pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  soapui_project_path: 'soapui-project-remove/CountryCurrencyProject-soapui-project.xml'
  soapui_install_dir: '$(Build.SourcesDirectory)/soapui'
  report_output_dir: '$(Build.ArtifactStagingDirectory)/soapui-reports'

stages:
- stage: RunSoapUITests
  displayName: 'Execute SoapUI Tests and Publish Report'
  jobs:
  - job: SoapUITests
    displayName: 'Run SoapUI Project'
    steps:

    # ‚úÖ Explicitly install Java 11
    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '11'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'
      displayName: 'Install Java 11'

    # ‚úÖ Verify Java is now Java 11
    - script: |
        echo "‚úÖ Verifying Java version..."
        java -version
        echo "‚úÖ JAVA_HOME is set to: $JAVA_HOME"
      displayName: 'Verify Java 11'

    # ‚úÖ Download and extract SoapUI from SmartBear‚Äôs official S3
    - script: |
        echo "‚¨áÔ∏è Downloading SoapUI..."
        wget https://s3.amazonaws.com/downloads.eviware/soapuios/5.7.0/SoapUI-5.7.0-linux-bin.tar.gz
        mkdir -p $(soapui_install_dir)
        tar -xvzf SoapUI-5.7.0-linux-bin.tar.gz -C $(soapui_install_dir) --strip-components=1
      displayName: 'Download & Extract SoapUI'

    # ‚úÖ Check project file exists
    - script: |
        echo "üìÅ Checking SoapUI project file:"
        ls -l "$(Build.SourcesDirectory)/$(soapui_project_path)"
      displayName: 'Check SoapUI Project File'

    # ‚úÖ Run SoapUI Tests
    - script: |
        echo "üöÄ Running SoapUI Project..."
        chmod +x $(soapui_install_dir)/bin/testrunner.sh
        $(soapui_install_dir)/bin/testrunner.sh "$(Build.SourcesDirectory)/$(soapui_project_path)" -s "CountryInfoServiceSoapBinding12 TestSuite" -r -j -f"$(report_output_dir)"
      displayName: 'Execute SoapUI Tests with Java 11'

    # ‚úÖ Publish reports
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(report_output_dir)'
        artifactName: 'soapui-test-results'
        publishLocation: 'Container'
      displayName: 'Publish SoapUI Test Results'